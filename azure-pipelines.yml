trigger:
- none

pool: Default

variables:
  TF_DIR: '$(System.DefaultWorkingDirectory)/env/dev'
  TERRATEST_DIR: '$(System.DefaultWorkingDirectory)/terratest'

stages:

# =========================================================
# BUILD / PRECHECK STAGE
# =========================================================
- stage: Build
  displayName: "Terraform Precheck"
  jobs:
  - job: precheck
    displayName: "Terraform Init & Plan"
    steps:

    - checkout: self

    # ---------- Terraform Init ----------
    - task: TerraformTask@5
      displayName: "Terraform Init"
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(TF_DIR)'
        backendServiceArm: 'myconnection'
        backendAzureRmResourceGroupName: 'rg-mahesh-11'
        backendAzureRmStorageAccountName: 'maheshstg12'
        backendAzureRmContainerName: 'mahesh'
        backendAzureRmKey: 'dev.tfstate'

    # ---------- Terraform Plan ----------
    - task: TerraformTask@5
      displayName: "Terraform Plan"
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(TF_DIR)'
        commandOptions: '-out=tfplan'
        environmentServiceNameAzureRM: 'myconnection'

    # ---------- Install Infracost ----------
    - powershell: |
        Write-Host "Installing Infracost..."
        $dir = "$(Agent.TempDirectory)\infracost"
        New-Item -ItemType Directory -Force -Path $dir | Out-Null

        Invoke-WebRequest https://infracost.io/downloads/latest/infracost-windows-amd64.zip `
          -OutFile "$dir\infracost.zip"

        Expand-Archive "$dir\infracost.zip" -DestinationPath $dir -Force

        Write-Host "##vso[task.prependpath]$dir"

        & "$dir\infracost.exe" --version
      displayName: "Install Infracost (Windows)"

    # ---------- Infracost Cost Estimation ----------
    - powershell: |
        infracost breakdown --path "$(TF_DIR)" --format table
      displayName: "Infracost Cost Estimation"
      env:
        INFRACOST_API_KEY: $(INFRACOST_API_KEY)

# =========================================================
# TERRATEST STAGE
# =========================================================
- stage: Terratest
  displayName: "Terraform Tests (Terratest)"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: terratest
    displayName: "Run Terratest"
    steps:

    - checkout: self

    - task: GoTool@0
      inputs:
        version: '1.10'
    - powershell: |
        cd "$(System.DefaultWorkingDirectory)\module\terratest"
        go mod tidy
      displayName: "Install Terratest Dependencies"

    - powershell: |
        cd "$(TERRATEST_DIR)"
        go test -v -timeout 30m
      displayName: "Execute Terratest"

# =========================================================
# SECURITY SCANNING STAGE
# =========================================================
- stage: Scanning
  displayName: "Security Scanning"
  dependsOn: Terratest
  condition: succeeded()
  jobs:
  - job: tfscan
    displayName: "Terraform Security Scan"
    steps:

    - checkout: self

    - task: tfsec@1
      inputs:
        version: 'v1.26.0'

    - task: trivy@2
      inputs:
        type: filesystem
        target: '$(TF_DIR)'
        severity: 'HIGH,CRITICAL'
        version: 'latest'

# =========================================================
# MANUAL APPROVAL STAGE
# =========================================================
- stage: Approval
  displayName: "Manual Approval Stage"
  dependsOn: Scanning
  condition: succeeded()
  jobs:
  - deployment: ManualApproval
    displayName: "Wait for Approval"
    environment: dev
    pool: server
    strategy:
      runOnce:
        deploy:
          steps:
          - task: ManualValidation@0
            inputs:
              notifyUsers: 'mahesh1tiwari'
              instructions: 'Please approve Terraform Apply to continue.'

# =========================================================
# APPLY STAGE (MAIN BRANCH ONLY)
# =========================================================
- stage: TerraformApply
  displayName: "Terraform Apply"
  dependsOn: Approval
  condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'main'))
  jobs:
  - job: Apply
    displayName: "Terraform Apply Job"
    steps:

    - checkout: self

    - task: TerraformTask@5
      displayName: "Terraform Init (Apply)"
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(TF_DIR)'
        backendServiceArm: 'myconnection'
        backendAzureRmResourceGroupName: 'rg-mahesh-11'
        backendAzureRmStorageAccountName: 'maheshstg12'
        backendAzureRmContainerName: 'mahesh'
        backendAzureRmKey: 'dev.tfstate'

    - task: TerraformTask@5
      displayName: "Terraform Apply"
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(TF_DIR)'
        commandOptions: '-auto-approve'
        environmentServiceNameAzureRM: 'myconnection'
