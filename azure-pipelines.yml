trigger:
- none

pool: Default

variables:
  TF_DIR: '$(Build.SourcesDirectory)/env/dev'
  TERRATEST_DIR: '$(Build.SourcesDirectory)/module/terratest'

# =========================================================
# BUILD / PRECHECK STAGE
# =========================================================
stages:
- stage: Build
  displayName: "Terraform Precheck"
  jobs:
  - job: precheck
    displayName: "Terraform Init & Plan"
    steps:

    - checkout: self

    # ---------- Terraform Init ----------
    - task: TerraformTask@5
      displayName: "Terraform Init"
      inputs:
        provider: azurerm
        command: init
        workingDirectory: $(TF_DIR)
        backendServiceArm: myconnection
        backendAzureRmResourceGroupName: rg-mahesh-11
        backendAzureRmStorageAccountName: maheshstg12
        backendAzureRmContainerName: mahesh
        backendAzureRmKey: dev.tfstate

    # ---------- Terraform Plan ----------
    - task: TerraformTask@5
      displayName: "Terraform Plan"
      inputs:
        provider: azurerm
        command: plan
        workingDirectory: $(TF_DIR)
        commandOptions: "-out=tfplan"
        environmentServiceNameAzureRM: myconnection

    # ---------- Install Infracost ----------
    - task: PowerShell@2
      displayName: "Install Infracost"
      inputs:
        targetType: inline
        script: |
          $dir = "$(Agent.TempDirectory)\infracost"
          New-Item -ItemType Directory -Force -Path $dir | Out-Null
          Invoke-WebRequest https://infracost.io/downloads/latest/infracost-windows-amd64.zip -OutFile "$dir\infracost.zip"
          Expand-Archive "$dir\infracost.zip" -DestinationPath $dir -Force
          Write-Host "##vso[task.prependpath]$dir"
          infracost --version

    # ---------- Infracost Breakdown ----------
    - task: PowerShell@2
      displayName: "Infracost Cost Estimation"
      inputs:
        targetType: inline
        script: |
          infracost breakdown --path "$(TF_DIR)" --format table
      env:
        INFRACOST_API_KEY: $(INFRACOST_API_KEY)

# =========================================================
# TERRATEST STAGE
# =========================================================
- stage: Terratest
  displayName: "Terratest Validation"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: terratest
    displayName: "Run Terratest"
    steps:

    - checkout: self

    # ---------- DEBUG (VERY IMPORTANT) ----------
    - task: PowerShell@2
      displayName: "Debug Repo Structure"
      inputs:
        targetType: inline
        script: |
          echo "Sources Directory:"
          echo $(Build.SourcesDirectory)
          dir $(Build.SourcesDirectory)
          dir $(Build.SourcesDirectory)\module

    # ---------- Install Go ----------
    - task: GoTool@0
      displayName: "Install Go"
      inputs:
        version: '1.21'

    # ---------- Install Terratest Dependencies ----------
    - task: PowerShell@2
      displayName: "Install Terratest Dependencies"
      inputs:
        targetType: inline
        script: |
          if (!(Test-Path "$(TERRATEST_DIR)")) {
            Write-Error "Terratest directory not found"
            exit 1
          }
          cd "$(TERRATEST_DIR)"
          go mod tidy

    # ---------- Run Terratest ----------
    - task: PowerShell@2
      displayName: "Run Terratest"
      inputs:
        targetType: inline
        script: |
          cd "$(TERRATEST_DIR)"
          go test -v -timeout 30m

# =========================================================
# SECURITY SCANNING STAGE
# =========================================================
- stage: Scanning
  displayName: "Security Scanning"
  dependsOn: Terratest
  condition: succeeded()
  jobs:
  - job: scan
    displayName: "tfsec & trivy"
    steps:

    - checkout: self

    - task: tfsec@1
      displayName: "Run tfsec"
      inputs:
        version: v1.26.0

    - task: trivy@2
      displayName: "Run Trivy"
      inputs:
        type: filesystem
        target: $(TF_DIR)
        severity: HIGH,CRITICAL
        version: latest

# =========================================================
# MANUAL APPROVAL
# =========================================================
- stage: Approval
  displayName: "Manual Approval"
  dependsOn: Scanning
  condition: succeeded()
  jobs:
  - deployment: Approval
    displayName: "Approval Required"
    environment: dev
    pool: server
    strategy:
      runOnce:
        deploy:
          steps:
          - task: ManualValidation@0
            inputs:
              notifyUsers: mahesh1tiwari
              instructions: "Approve to run Terraform Apply"

# =========================================================
# APPLY (MAIN BRANCH ONLY)
# =========================================================
- stage: Apply
  displayName: "Terraform Apply"
  dependsOn: Approval
  condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'main'))
  jobs:
  - job: apply
    displayName: "Terraform Apply"
    steps:

    - checkout: self

    - task: TerraformTask@5
      displayName: "Terraform Init (Apply)"
      inputs:
        provider: azurerm
        command: init
        workingDirectory: $(TF_DIR)
        backendServiceArm: myconnection
        backendAzureRmResourceGroupName: rg-mahesh-11
        backendAzureRmStorageAccountName: maheshstg12
        backendAzureRmContainerName: mahesh
        backendAzureRmKey: dev.tfstate

    - task: TerraformTask@5
      displayName: "Terraform Apply"
      inputs:
        provider: azurerm
        command: apply
        workingDirectory: $(TF_DIR)
        commandOptions: "-auto-approve"
        environmentServiceNameAzureRM: myconnection
