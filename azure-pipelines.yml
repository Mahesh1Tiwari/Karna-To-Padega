trigger:
- none

pool:
  name: Default

variables:
  TF_DIR: '$(System.DefaultWorkingDirectory)/env/dev'

stages:

# =====================================================
# BUILD / PRECHECK STAGE
# =====================================================
- stage: Build
  displayName: "Terraform Precheck"
  jobs:
  - job: precheck
    displayName: "Terraform Init, Plan & Cost"
    steps:

    - task: TerraformTask@5
      displayName: "Terraform Init"
      inputs:
        provider: azurerm
        command: init
        workingDirectory: $(TF_DIR)
        backendServiceArm: myconnection
        backendAzureRmResourceGroupName: rg-mahesh-11
        backendAzureRmStorageAccountName: maheshstg12
        backendAzureRmContainerName: mahesh
        backendAzureRmKey: dev.tfstate

    - task: TerraformTask@5
      displayName: "Terraform Plan"
      inputs:
        provider: azurerm
        command: plan
        workingDirectory: $(TF_DIR)
        commandOptions: '-out=tfplan'
        environmentServiceNameAzureRM: myconnection

    # -------- INFRACOST INSTALL (SAFE - NO ADMIN) --------
    - powershell: |
        Write-Host "Installing Infracost safely..."
        $dir = "$(Agent.TempDirectory)\infracost"
        New-Item -ItemType Directory -Force -Path $dir | Out-Null

        Invoke-WebRequest `
          -Uri https://infracost.io/downloads/latest/infracost-windows-amd64.zip `
          -OutFile "$dir\infracost.zip"

        Expand-Archive "$dir\infracost.zip" -DestinationPath $dir -Force

        Write-Host "##vso[task.prependpath]$dir"
        infracost --version
      displayName: "Install Infracost (Windows)"

    # -------- INFRACOST COST ESTIMATION --------
    - powershell: |
        infracost breakdown `
          --path "$(TF_DIR)" `
          --terraform-plan-file "$(TF_DIR)\tfplan" `
          --format table
      displayName: "Infracost Cost Estimation"
      env:
        INFRACOST_API_KEY: $(INFRACOST_API_KEY)

# =====================================================
# SECURITY SCANNING STAGE
# =====================================================
- stage: Scanning
  displayName: "Security Scanning"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: tfscan
    displayName: "tfsec & Trivy Scan"
    steps:

    - task: tfsec@1
      displayName: "Terraform Security Scan"
      inputs:
        version: v1.26.0

    - task: trivy@2
      displayName: "Trivy Filesystem Scan"
      inputs:
        type: filesystem
        target: $(TF_DIR)
        severity: HIGH,CRITICAL
        version: latest

# =====================================================
# MANUAL APPROVAL STAGE
# =====================================================
- stage: Approval
  displayName: "Manual Approval"
  dependsOn: Scanning
  condition: succeeded()
  jobs:
  - deployment: ManualApproval
    displayName: "Wait for Approval"
    environment: dev
    pool: server
    strategy:
      runOnce:
        deploy:
          steps:
          - task: ManualValidation@0
            inputs:
              notifyUsers: 'mahesh1tiwari'
              instructions: 'Approve Terraform Apply to continue'

# =====================================================
# TERRAFORM APPLY STAGE
# =====================================================
- stage: TerraformApply
  displayName: "Terraform Apply"
  dependsOn: Approval
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: Apply
    displayName: "Terraform Apply Job"
    steps:

    - task: TerraformTask@5
      displayName: "Terraform Init"
      inputs:
        provider: azurerm
        command: init
        workingDirectory: $(TF_DIR)
        backendServiceArm: myconnection
        backendAzureRmResourceGroupName: rg-mahesh-11
        backendAzureRmStorageAccountName: maheshstg12
        backendAzureRmContainerName: mahesh
        backendAzureRmKey: dev.tfstate

    - task: TerraformTask@5
      displayName: "Terraform Apply"
      inputs:
        provider: azurerm
        command: apply
        workingDirectory: $(TF_DIR)
        commandOptions: '-auto-approve'
        environmentServiceNameAzureRM: myconnection
